; platformio.ini - ESP32 GPS Tracker dengan Offline Storage Support
; PlatformIO Project Configuration File

[platformio]
default_envs = esp32dev

[env:esp32dev]
platform = espressif32
board = esp32dev
framework = arduino
monitor_speed = 115200
upload_speed = 115200
board_build.flash_mode = dio
monitor_filters = esp32_exception_decoder

; BARU: Custom partition untuk SPIFFS offline storage
board_build.partitions = partitions.csv
board_build.filesystem = spiffs

; Library dependencies
lib_deps =
    vshymanskyy/TinyGSM@^0.11.7
    arduino-libraries/ArduinoHttpClient@^0.5.0
    mikalhart/TinyGPSPlus@^1.0.3
    bblanchon/ArduinoJson@^6.21.3

; Build flags dengan offline storage support
build_flags = 
    -D CORE_DEBUG_LEVEL=3
    -D TINY_GSM_MODEM_SIM7600
    -D TINY_GSM_USE_GPRS=true
    -D TINY_GSM_DEBUG=Serial
    -D ENABLE_OFFLINE_STORAGE=true
    -D OFFLINE_MAX_RECORDS=100
    -D OFFLINE_AUTO_SYNC=true

; Environment untuk testing dengan offline storage
[env:esp32dev_offline_test]
platform = espressif32
board = esp32dev
framework = arduino
monitor_speed = 115200
upload_speed = 921600
board_build.partitions = partitions.csv
lib_deps = ${env:esp32dev.lib_deps}
build_flags = 
    ${env:esp32dev.build_flags}
    -D UNIT_TEST_MODE
    -D OFFLINE_DEBUG_MODE=true
    -D OFFLINE_MAX_RECORDS=50        ; Reduced untuk testing
    -D OFFLINE_SYNC_BATCH_SIZE=3     ; Smaller batches untuk testing
build_src_filter = 
    +<*>
    -<main.ino>
    +<unit_tests.ino>

; Environment production dengan optimasi
[env:esp32dev_production]
platform = espressif32
board = esp32dev
framework = arduino
monitor_speed = 115200
upload_speed = 921600
board_build.partitions = partitions.csv
lib_deps = ${env:esp32dev.lib_deps}
build_flags = 
    -D CORE_DEBUG_LEVEL=0
    -D TINY_GSM_MODEM_SIM7600
    -D TINY_GSM_USE_GPRS=true
    -D ESP_TASK_WDT_TIMEOUT_S=30
    -D ENABLE_OFFLINE_STORAGE=true
    -D OFFLINE_MAX_RECORDS=200       ; Lebih banyak untuk production
    -D OFFLINE_AUTO_SYNC=true
    -D OFFLINE_MAINTENANCE_INTERVAL=600000  ; 10 menit maintenance
    -O2

; Environment untuk development dengan debug penuh
[env:esp32dev_debug]
platform = espressif32
board = esp32dev
framework = arduino
monitor_speed = 115200
upload_speed = 460800
board_build.partitions = partitions.csv
lib_deps = ${env:esp32dev.lib_deps}
build_flags = 
    -D CORE_DEBUG_LEVEL=5
    -D TINY_GSM_MODEM_SIM7600
    -D TINY_GSM_USE_GPRS=true
    -D TINY_GSM_DEBUG=Serial
    -D ENABLE_OFFLINE_STORAGE=true
    -D OFFLINE_DEBUG_MODE=true
    -D OFFLINE_VERBOSE_LOGGING=true
    -D DEBUG_MODE=true
    -g -O0

; Konfigurasi tambahan untuk semua environments
[env]
; Monitor configuration
monitor_port = /dev/ttyUSB0
monitor_dtr = 0
monitor_rts = 0

; Upload configuration  
upload_port = /dev/ttyUSB0
upload_protocol = esptool

; SPIFFS configuration
board_build.filesystem = spiffs

; Kompilasi options
build_unflags = -Os
build_flags = -O2

; Custom build scripts (optional)
; extra_scripts = 
;     pre:scripts/pre_build.py
;     post:scripts/post_build.py

; ========================================
; KONFIGURASI SPIFFS OFFLINE STORAGE
; ========================================
; 
; Dengan partition table custom:
; - SPIFFS: 960KB untuk offline storage
; - Capacity: ~4800 GPS records (200 bytes each)
; - Recommended max: 200-500 records untuk safety
; 
; Estimasi storage per movement state:
; - MOVING (3s interval): 1200 records/hour = 240KB/hour
; - PARKED (30s interval): 120 records/hour = 24KB/hour  
; - STATIC (1h interval): 1 record/hour = 0.2KB/hour
;
; Dengan 960KB SPIFFS, bisa store:
; - 4 jam continuous MOVING mode, atau
; - 40 jam continuous PARKED mode, atau  
; - 4800 jam STATIC mode
; 
; Auto-cleanup setelah 24 jam mencegah overflow
; ========================================